<!--Contenedor principal-->
<div class="sm:p-6 md:p-8">
  <div class="max-w-4xl mx-auto">
    <!--1. Estado de Carga-->
    @if (exerciseResource.isLoading()) {
      <div class="space-y-6">
        <!--Skeleton del encabezado-->
        <div class="skeleton h-8 w-16 rounded-lg"></div>
        <div class="skeleton h-10 w-3/4 rounded-lg"></div>
        <div class="flex gap-2">
          <div class="skeleton h-6 w-24 rounded-full"></div>
          <div class="skeleton h-6 w-24 rounded-full"></div>
          <div class="skeleton h-6 w-24 rounded-full"></div>
        </div>
        <div class="divider"></div>
        <!--Skeleton del contenido-->
        <div class="skeleton h-64 w-full rounded-box"></div>
        <div class="space-y-2">
          <div class="skeleton h-4 w-full"></div>
          <div class="skeleton h-4 w-full"></div>
          <div class="skeleton h-4 w-3/4"></div>
        </div>
        <!--Skeleton del botón-->
        <div class="skeleton h-12 w-full mt-4 rounded-lg"></div>
      </div>
    } @else if (exerciseResource.error()) {
      <div class="alert alert-error">
        <span class="material-symbols-outlined">error</span>
        <span>Error al cargar el ejercicio. Por favor, intenta de nuevo.</span>
        <button class="btn btn-sm btn-ghost" (click)="reload()">
          Reintentar
        </button>
      </div>
    } @else if (!exerciseResource.value()) {
      <div role="alert" class="alert alert-warning">
        <span class="material-symbols-outlined">search_off</span>
        <div>
          <h3 class="font-bold">Ejercicio no encontrado</h3>
          <div class="text-xs">
            El ejercicio que buscas no existe o no está disponible.
          </div>
        </div>
        <a class="btn btn-sm" [routerLink]="['/app/exercises']">Volver</a>
      </div>
    } @else {
      @if (exerciseResource.value(); as exercise) {
        <div class="card bg-base-100 shadow-xl border border-base-300/50">
          <div class="card-body p-4 sm:p-8">
            <!--Encabezado con breadcrumbs-->
            <div class="mb-4 overflow-x-auto">
              <div class="breadcrumbs text-xs sm:text-sm">
                <ul>
                  <li><a [routerLink]="['/app']">Inicio</a></li>
                  <li><a [routerLink]="['/app/exercises']">Ejercicios</a></li>
                  @if (categoryResource.value(); as category) {
                    <li>
                      <a
                        [routerLink]="['/app/exercises/category', category.id]"
                        class="whitespace-nowrap"
                        >{{ category.localizedName["es"] }}</a
                      >
                    </li>
                  }
                  <li>
                    <span class="opacity-70 whitespace-nowrap">{{
                      exercise.localizedTitle["es"]
                    }}</span>
                  </li>
                </ul>
              </div>
            </div>

            <!--Título y Metadatos-->
            <h1
              class="card-title text-2xl sm:text-3xl md:text-4xl font-extrabold tracking-tight mb-3"
            >
              {{ exercise.localizedTitle["es"] }}
            </h1>
            <div class="flex flex-wrap gap-2 mb-6 text-sm">
              <div class="badge badge-secondary badge-outline gap-1.5 p-3">
                <span class="material-symbols-outlined !text-base"
                  >signal_cellular_alt</span
                >
                {{ exercise.difficulty }}
              </div>
              <div class="badge badge-accent badge-outline gap-1.5 p-3">
                <span class="material-symbols-outlined !text-base">timer</span>
                {{ exercise.durationMinutes || 0 }} min
              </div>
            </div>

            <!--Contenido dinámico del ejercicio-->
            <div class="w-full">
              @switch (exercise.contentType) {
                @case ("VIDEO") {
                  <!-- Reproductor de Video -->
                  <div class="w-full max-w-3xl mx-auto">
                    <div
                      class="relative w-full pt-[56.25%] rounded-xl overflow-hidden shadow-lg bg-black ring-1 ring-base-300"
                    >
                      @if (safeVideoUrl(); as videoUrl) {
                        <iframe
                          [src]="videoUrl"
                          class="absolute top-0 left-0 w-full h-full"
                          frameborder="0"
                          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                          allowfullscreen
                        ></iframe>
                      } @else if (isStandardVideo()) {
                        <video
                          class="absolute top-0 left-0 w-full h-full object-cover"
                          controls
                          [src]="exercise.contentUrl"
                        ></video>
                      }
                    </div>
                  </div>
                }
                @case ("TEXT") {
                  <!--Contenido de texto con imagen-->
                  @if (exercise.thumbnailUrl) {
                    <figure class="mb-6">
                      <img
                        [src]="exercise.thumbnailUrl"
                        [alt]="exercise.localizedTitle['es']"
                        class="rounded-xl w-full max-h-64 sm:max-h-96 object-cover shadow-md"
                      />
                    </figure>
                  }
                  <div class="prose prose-base sm:prose-lg max-w-none mb-6">
                    <p>{{ exercise.localizedContentText["es"] }}</p>
                  </div>
                }
                @case ("AUDIO") {
                  <div
                    class="card bg-base-200 shadow-inner max-w-2xl mx-auto mb-6"
                  >
                    <div class="card-body items-center text-center p-6">
                      <div
                        class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mb-3"
                      >
                        <span
                          class="material-symbols-outlined text-4xl text-primary"
                          >headphones</span
                        >
                      </div>
                      <h3 class="font-bold text-lg mb-1">Reproducir Audio</h3>
                      <p class="text-base-content/60 text-sm mb-4">
                        Escucha atentamente las instrucciones.
                      </p>

                      <audio
                        controls
                        class="w-full"
                        [src]="exercise.contentUrl"
                      >
                        Tu navegador no soporta el elemento de audio.
                      </audio>
                    </div>
                  </div>
                }
                @case ("GAME") {
                  <div class="alert alert-info shadow-md mb-6">
                    <span class="material-symbols-outlined"
                      >stadia_controller</span
                    >
                    <div>
                      <h3 class="font-bold">Juego Interactivo</h3>
                      <div class="text-xs">
                        El contenido interactivo estará disponible próximamente.
                      </div>
                    </div>
                  </div>
                }
              }
            </div>

            <!--Descripción adicional (si aplica)-->
            @if (exercise.contentType !== "TEXT") {
              <div class="divider my-2"></div>
              <div class="prose prose-base sm:prose-lg max-w-none mb-8">
                <h3 class="font-bold text-lg sm:text-xl mb-2">Descripción</h3>
                <p>{{ exercise.localizedDescription["es"] }}</p>
              </div>
            }

            <!--Acción-->
            <div class="card-actions justify-center mt-auto">
              <button
                class="btn btn-primary btn-wide shadow-lg hover:shadow-primary/30 transition-all"
                (click)="markAsComplete()"
              >
                <span class="material-symbols-outlined">check_circle</span>
                Marcar como Completado
              </button>
            </div>
          </div>
        </div>
      }
    }
  </div>
</div>
